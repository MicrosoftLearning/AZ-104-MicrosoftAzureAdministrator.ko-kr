---
lab:
  title: '랩 11: 모니터링 구현'
  module: Administer Monitoring
---

# 랩 11 - 모니터링 구현

## 랩 소개

이 랩에서는 Azure Monitor에 대해 알아봅니다. 작업 그룹에 보낼 경고를 만드는 방법을 알아봅니다. 경고를 트리거하고 활동 로그를 검사.  

이 랩에는 Azure 구독이 필요합니다. 구독 유형은 이 랩의 기능 가용성에 영향을 줄 수 있습니다. 지역을 변경할 수 있지만 단계는 미국 동부를 사용하여 작성됩니다.

## 예상 소요 시간: 40분

## 랩 시나리오

조직에서 인프라를 Azure로 마이그레이션했습니다. 관리 담당자에게 중요한 인프라 변경에 대한 알림을 제공하는 것이 중요합니다. Log Analytics를 포함하여 Azure Monitor의 기능을 검사할 계획입니다.

## 대화형 랩 시뮬레이션

이 항목에 유용할 수 있는 대화형 랩 시뮬레이션이 있습니다. 시뮬레이션을 사용하면 비슷한 시나리오를 원하는 속도로 클릭할 수 있습니다. 대화형 시뮬레이션과 이 랩 사이에는 차이점이 있지만, 대부분의 핵심 개념은 동일합니다. Azure 구독은 필요하지 않습니다.

+ [모니터링을 구현합니다](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2017). Log Analytics 작업 영역 및 Azure 자동화 솔루션을 만듭니다. 가상 머신에 대한 모니터링 및 진단 설정을 검토합니다. Azure Monitor 및 Log Analytics 기능을 검토합니다. 

## 아키텍처 다이어그램

![아키텍처 작업의 다이어그램](../media/az104-lab11-architecture-diagram.png)

## 작업

+ 작업 1: 랩 환경을 프로비저닝합니다.
+ 작업 2: Azure 활동 로그 경고를 만듭니다.
+ 작업 3: 경고를 트리거합니다.
+ 작업 4: 경고 규칙을 추가합니다.
+ 작업 5: Azure Monitor 로그 쿼리를 사용합니다.

## 작업 1: 랩 환경 프로비전

이 작업에서는 모니터링 시나리오를 테스트하는 데 사용할 가상 머신을 배포합니다.

1. 필요한 경우 Allfiles Labs\\11\\az104-11-vm-template.json** 및\\** Allfiles\\Labs\\11\\az104-11-vm-parameters.json** 랩 파일을 컴퓨터에 다운로드\\**합니다.\\

1. **Azure Portal** - `https://portal.azure.com`에 로그인합니다.

1. Azure Portal에서 검색하여 선택합니다 `Deploy a custom template`.

1. 사용자 지정 배포 페이지에서 편집기**에서 고유한 템플릿 빌드를 선택합니다**.

1. 템플릿 편집 페이지에서 파일** 로드를 선택합니다**.

1. Allfiles\\Labs\\11 az104-11-vm-template.json\\** 파일을 찾아 선택하고 열기**를 선택합니다**.**\\

1. **저장**을 선택합니다.

1. 사용자 지정 배포 페이지에서 매개 변수** 편집을 선택합니다**.

1. 매개 변수 편집 페이지에서 파일** 로드를 선택합니다**. **\\Allfiles\\Labs\\11\\az104-11-vm-parameters.json** 파일을 찾아 선택하고 열기**를 선택합니다**.

1. **저장**을 선택합니다.

1. 다음 정보를 사용하여 사용자 지정 배포 필드를 완료하고 다른 모든 필드에 기본값을 남깁니다.

    | 설정       | 값         | 
    | ---           | ---           |
    | Subscription  | Azure 구독 |
    | Resource group| `az104-rg11` (필요한 ** 경우새로** 만들기)
    | 지역        | **미국 동부**   |
    | 사용자 이름      | `Student`   |
    | 암호      | 복잡한 암호 제공 |
    
1. **검토 + 만들기**, **만들기**를 차례로 선택합니다.

1. 배포가 완료되기를 기다린 다음 리소스 그룹으로** 이동을 클릭합니다**.

1. 가상 머신 및 가상 네트워크를 포함하여 배포된 리소스를 검토합니다.

    >**참고:** 랩의 뒷부분에서 Azure Monitor를 사용하므로 가상 머신 에이전트를 설치하는 데 1분 정도 소요됩니다.

1. 포털에서 모니터**를 검색하고 선택합니다**.

1. 사용 가능한 모든 인사이트, 검색, 심사 및 진단 도구를 검토하는 데 잠시 시간이 걸릴 수 있습니다.

1. VM 인사이트 보기를** 선택한 **다음, 인사이트 구성을** 선택합니다**.

1. 가상 머신을 선택한 다음 **사용** (두 번)합니다.

1. 에이전트가 설치 및 구성하고 다음 단계를 진행하는 데 몇 분 정도 걸립니다. 
   
## 작업 2: Azure 활동 로그 경고 만들기

1. Azure Portal에서 모니터**를 검색하고 선택합니다**. 

1. 모니터링 메뉴에서 **경고**를 선택합니다. 

1. **만들기 +** 를 선택하고 경고 규칙을** 선택합니다**. **범위** 섹션이 열려 있고 오른쪽에 **리소스 선택** 창이 열려 있고 **경고 규칙 생성** 창이 나타납니다.

1. **리소스** 선택 창**에서 구독** 기준 필터 필드가 이미 채워져 있어야 합니다. **리소스 종류별로 필터링** 드롭다운 목록에서 **가상 머신**을 검색하여 선택합니다.

1. 리소스 그룹의 가상 머신이 삭제되는 경우 경고가 발생하도록 하려고 합니다. az104-rg11 리소스 그룹에 대한 **상자를 선택한 다음 적용을 선택합니다****.**

1. 조건 탭을 **선택한 다음 모든 신호** 보기 링크를 선택합니다**.**

1. Virtual Machine(Virtual Machines)을 검색하여 삭제를** 선택합니다**. **적용**을 선택합니다.

1. 모든 형식의 경고를 수신하고 **경고 논리** 설정을 기본값인 **모두 선택**으로 둡니다. 다음 섹션에 대한 **경고 규칙 만들기** 창을 열어 둡니다.

## 작업 3: 전자 메일 경고 작업 추가

이전 Azure Monitor 경고에 대해서는 작업을 추가하지 않았습니다. Azure Portal에서 트리거된 경고를 방금 확인했습니다. 작업을 통해 알림에 대한 전자 메일을 보내거나 Azure 함수를 트리거하거나 웹후크를 호출할 수 있습니다. 이 연습에서는 VM이 삭제될 때 메일 경고를 추가합니다.

1. **경고 규칙 만들기** 창에서 **다음: 작업** 단추를 선택하고 **작업 그룹 만들기**를 선택합니다. 

1. **기본** 탭에서 각 설정에 다음 값을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | **프로젝트 세부 정보** |
    | Subscription | 구독 |
    | 리소스 그룹 | **az104-rg11** |
    | 지역 | **전역**(기본값) |
    | **인스턴스 세부 정보** |
    | 작업 그룹 이름 | **운영 팀에 경고**. |
    | 표시 이름 | **AlertOpsTeam** |

1. 다음: 알림을 선택하고 **각 설정에 대해 다음 값을 입력합니다** .

    | 설정 | 값 |
    |---------|---------|
    | 알림 유형 | **메일/SMS 메시지/푸시/음성**을 선택합니다. |
    | 이름 | **VM이 삭제됨** |

1. **이메일**을 선택하고 **이메일** 상자에 이메일 주소를 입력한 다음 **확인**을 선택합니다. 

1. **검토 + 만들기**를 선택하여 입력의 유효성을 검사합니다.

1. **만들기**를 실행합니다.
 
1. **경고 규칙 만들기** 창이 다시 나타납니다. **다음: 세부 정보** 단추를 선택하고 각 설정에 다음 값을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | 경고 규칙 이름 | **VM이 삭제됨** |
    | Description | **리소스 그룹의 VM이 삭제됨** |

1. **고급 옵션** 섹션을 확장하고 **만들 때 경고 규칙 사용**이 선택되어 있는지 확인합니다.

1. **검토 + 만들기**를 선택하여 입력의 유효성을 검사한 다음, **만들기**를 선택합니다.

    >**참고:** 구성된 작업 그룹(운영 팀)에 추가된 받는 사람은 다음과 같은 알림을 받습니다.

    - 작업 그룹에 추가되는 경우
    - 경고가 활성화되는 경우
    - 경고가 트리거되는 경우

## 작업 4: 경고 트리거

경고를 트리거하려면 리소스 그룹에서 가상 머신을 삭제합니다.

>**참고:** 활동 로그 경고 규칙이 활성화되는 데 최대 5분이 걸릴 수 있습니다. 이 연습에서는 규칙이 배포되기 전에 가상 머신을 삭제하면 경고 규칙이 트리거되지 않을 수 있습니다. 

1. Azure Portal 메뉴 또는 **홈** 페이지에서 **가상 머신**을 선택합니다.

1. az104-vm0** 가상 머신에 대한 **확인란을 선택합니다.

1. 메뉴 모음에서 **삭제**를 선택합니다.

1. **삭제 확인** 필드에 “예”를 입력한 다음, **삭제**를 선택합니다.

1. 제목 표시줄에서 **알림** 아이콘을 선택하고 **vm1**이 성공적으로 삭제될 때까지 기다립니다.

1. 다음과 같은 알림 메일을 받았어야 합니다. **중요 알림: Azure Monitor 경고 VM이 활성화되었습니다...** 그렇지 않은 경우 메일 프로그램을 열고 azure-noreply@microsoft.com에서 메일을 찾습니다.

    ![경고 메일의 스크린샷.](../media/az104-lab11-alert-email.png)

1. Azure Portal 리소스 메뉴에서 **모니터**를 선택한 다음, 왼쪽 메뉴에서 **경고**를 선택합니다.

1. **vm1**을 삭제하여 생성된 세 가지 자세한 경고가 표시되어야 합니다.

1. 경고 중 하나의 이름을 선택합니다(예: **VM이 삭제되었음**). 이벤트에 대한 자세한 정보를 보여주는 **경고 정보** 창이 표시됩니다.

## 작업 5: 경고 규칙 추가

하룻밤에 한 번 계획된 유지 관리를 예약할 것입니다. 이 일정은 저녁에 시작하여 다음 날 아침까지 계속됩니다.

1. Azure Portal 리소스 메뉴에서 **모니터**를 선택하고 왼쪽 메뉴에서 **경고를** 선택한 다음 메뉴 모음에서 **경고 처리 규칙을** 선택합니다.
   
1. **+ 만들기**를 선택합니다.
   
1. 샌드박스 리소스 그룹에 대한 확인란을 경고 처리 규칙의 범위로 선택한 다음, **적용**을 선택합니다.
   
1. **다음: 규칙 설정**을 선택한 다음, **알림 표시 안 함**을 선택합니다.
   
1. **다음: 예약**을 선택합니다.
   
1. 기본적으로 규칙은 사용하지 않도록 설정하지 않는 한 항상 작동합니다. 하룻밤에 한 번 계획된 유지 관리에 대한 알림을 표시하지 않는 규칙을 정의하려고 합니다.
경고 처리 규칙의 일정에 대해 다음 설정을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    |규칙 적용 |특정 시간에|
    |시작|오늘 날짜를 오후 10시에 입력합니다.|
    |끝|내일 오전 7시에 날짜를 입력합니다.|
    |표준 시간대|로컬 표준 시간대를 선택합니다.|

    ![경고 처리 규칙의 예약 섹션 스크린샷](../media/az104-lab11-alert-processing-rule-schedule.png)

1. **다음: 세부 정보**를 선택하고 다음 설정을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    |Resource group |샌드박스 리소스 그룹을 선택합니다. |
    |규칙 이름|**계획된 유지 관리**|
    |Description|**계획된 유지 관리 기간 중 알림 표시 안 함**|

1. **검토 + 만들기**를 선택하여 입력의 유효성을 검사한 다음, **만들기**를 선택합니다.

## 작업 6: Azure Monitor 로그 쿼리 사용

이 작업에서는 Azure Monitor를 사용하여 가상 머신에서 캡처한 데이터를 쿼리합니다.

1. Azure Portal에서 블레이드를 검색하고 선택하고 `Monitor` 로그를** 클릭합니다**.

    >**참고**: Log Analytics에 처음으로 액세스한다면 **시작**을 클릭해야 합니다. 사용** 단추가 **계속 표시되면 이전 배포가 완료되기를 기다립니다.

1. 필요한 경우 범위 선택을 클릭하고 **범위** 선택 블레이드에서 **구독을 확장하고 리소스 그룹 **az104-rg1**을 확장한 다음 az104-vm0**을 선택하고 **적용**을 클릭합니다**.**

1. 쿼리 창에 다음 쿼리를 붙여넣고 **실행**을 클릭한 후에 표시되는 차트를 검토합니다.

   ```sh
   // Virtual Machine available memory
   // Chart the VM's available memory over the last hour.
   InsightsMetrics
   | where TimeGenerated > ago(1h)
   | where Name == "AvailableMB"
   | project TimeGenerated, Name, Val
   | render timechart
   ```

    > **참고**: 쿼리에 오류가 없어야 합니다(오른쪽 스크롤 막대의 빨간색 블록으로 표시됨). 쿼리가 오류 없이 붙여넣지 않으면 쿼리 코드를 메모장 같은 텍스트 편집기에 붙여넣은 다음 복사하여 쿼리 창에 붙여넣습니다.


1. 도구 모음에서 쿼리를 클릭합니다 **.** 

    >**참고**: 화면 해상도 **에 따라 쿼리가** 말뚝 뒤에 숨겨질 수 있습니다.

1. 기존 필터를 지웁니다. 쿼리 검색을 사용하여 검색한 `Track VM Availability using Heartbeat` 다음 실행을** 선택합니다**.

1. 쿼리의 **결과** 탭을 선택하고 쿼리 결과를 검토합니다.

## 랩의 기본 지점 검토

랩을 완료한 것을 축하합니다. 다음은 이 랩에 대한 기본 설명입니다. 

+ 경고는 사용자가 인프라 또는 애플리케이션에 문제가 있을 수 있음을 알리기 전에 문제를 감지하고 해결하는 데 도움이 됩니다.

+ Azure Monitor 데이터 플랫폼의 모든 메트릭 또는 로그 데이터 원본에 대해 경고할 수 있습니다.

+ 경고 규칙은 데이터를 모니터링하고 지정된 리소스에서 문제가 발생하고 있음을 나타내는 신호를 캡처합니다.

+ 경고 규칙의 조건이 충족되면 경고이 트리거됩니다. 여러 작업(이메일, SMS, 푸시, 음성)을 시작하고 작업 그룹으로 보낼 수 있습니다. 

## 리소스 정리

고유한 구독으로 작업하는 경우 랩 리소스를 삭제하는 데 1분이 소요됩니다. 이렇게 하면 리소스가 해제되고 비용이 최소화됩니다. 랩 리소스를 삭제하는 가장 쉬운 방법은 랩 리소스 그룹을 삭제하는 것입니다. 

+ Azure Portal에서 리소스 그룹을 선택하고, 리소스 그룹 삭제를 선택하고 **, **리소스 그룹** 이름을** 입력한 다음, 삭제**를 클릭합니다**.

+ Azure PowerShell 사용. `Remove-AzResourceGroup -Name resourceGroupName` 

+ CLI `az group delete --name resourceGroupName`를 사용하여 .

