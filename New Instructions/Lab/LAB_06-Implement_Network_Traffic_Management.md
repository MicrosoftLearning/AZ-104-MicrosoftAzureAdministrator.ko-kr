---
lab:
  title: '랩 06: 트래픽 관리 구현'
  module: Administer Network Traffic Management
---

# 랩 06 - 트래픽 관리 구현

## 랩 소개

이 랩에서는 공용 Load Balancer를 구성하고 테스트하는 방법을 알아봅니다. Application Gateway를 구성하고 테스트하는 방법도 알아봅니다. 

이 랩에는 Azure 구독이 필요합니다. 구독 유형은 이 랩의 기능 가용성에 영향을 줄 수 있습니다. 지역을 변경할 수 있지만 단계는 미국 동부를 사용하여 작성됩니다.

## 예상 소요 시간: 40분

## 랩 시나리오

조직에서는 최근 허브 및 스포크 네트워크 토폴로지에서 Azure 가상 머신에 대한 네트워크 트래픽 관리를 완료했습니다. 이제 계층 4 및 계층 7 부하 분산 장치를 사용하여 가상 머신 간에 트래픽 분산을 테스트하려고 합니다. 이 목적을 위해 Azure Load Balancer(계층 4) 및 Azure Application Gateway(계층 7)를 사용하려고 합니다.

## 대화형 랩 시뮬레이션

이 항목에 유용할 수 있는 대화형 랩 시뮬레이션이 있습니다. 시뮬레이션을 사용하면 비슷한 시나리오를 원하는 속도로 클릭할 수 있습니다. 대화형 시뮬레이션과 이 랩 사이에는 차이점이 있지만, 대부분의 핵심 개념은 동일합니다. Azure 구독은 필요하지 않습니다.

+ [Azure 부하 분산 장치 및 Azure 부하 분산](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Create%20and%20configure%20an%20Azure%20load%20balancer) 장치를 만들고 구성합니다. 가상 네트워크, 백 엔드 서버, 부하 분산 장치를 만든 다음 부하 분산 장치를 테스트합니다. 
+ [Azure 애플리케이션 게이트웨이를 배포합니다](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Deploy%20Azure%20Application%20Gateway). 애플리케이션 게이트웨이를 만들고, 가상 머신을 만들고, 백 엔드 풀을 만들고, 게이트웨이를 테스트합니다. 
+ [트래픽 관리를 구현합니다](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2010). 가상 머신, 가상 네트워크, 피어링, 부하 분산 장치 및 애플리케이션 게이트웨이를 비롯한 전체 허브 및 스포크 네트워크를 구현합니다.

## 작업

+ 작업 1: 랩 환경 프로비전
+ 작업 2: Azure Load Balancer 구현
+ 작업 3: Azure 애플리케이션 게이트웨이 구현
+ 작업 4: Network Watcher를 사용하여 네트워크 연결 테스트



## 작업 1: 랩 환경 프로비전

이 작업에서는 템플릿을 사용하여 연결된 가상 네트워크 인터페이스 카드 함께 하나의 가상 네트워크, 하나의 네트워크 보안 그룹 및 2개의 가상 머신을 배포합니다. VM은 az104-vnet1**이라는 **허브 가상 네트워크에 상주합니다.

1. 필요한 경우 Allfiles Labs\\06\\az104-06-vms-loop-template.json** 및\\** Allfiles\\Labs\\06\\az104-06-vms-loop-parameters.json** 랩 파일을 컴퓨터에 다운로드\\**합니다.\\

1. **Azure Portal** - `https://portal.azure.com`에 로그인합니다.

1. `Deploy a custom template`을 검색하고 선택합니다.

1. 사용자 지정 배포 페이지에서 편집기**에서 고유한 템플릿 빌드를 선택합니다**.

1. 템플릿 편집 페이지에서 파일** 로드를 선택합니다**.

1. **\\Allfiles\\Labs\\06\\az104-06-vms-loop-template.json** 파일을 찾아 선택하고 열기**를 선택합니다**.

1. **저장**을 선택합니다.

1. 다음 정보를 사용하여 사용자 지정 배포 페이지의 필드를 완료하고 다른 모든 필드는 기본값으로 그대로 둡다.

    | 설정       | 값         | 
    | ---           | ---           |
    | Subscription  | Azure 구독 |
    | Resource group| `az104-rg6` (필요한 ** 경우새로** 만들기)
    | 지역        | **미국 동부**   |
    | VM 크기       | **표준 DS2 v3** |
    | 관리자 사용자 이름| `localadmin` |
    | 암호      | 보안 암호 제공 |

     >**참고**: VM 크기를 사용할 수 없다는 오류가 표시되면 구독에서 사용할 수 있고 코어가 2개 이상 있는 SKU를 선택합니다.

1. **검토 + 생성**를 선택한 다음, **생성**를 선택합니다.

    >**참고**: 다음 작업으로 이동하기 전에 배포가 완료되기를 기다립니다. 배포는 약 5분 후에 완료되어야 합니다.
    
    >**참고:** 기다리는 동안 Network Watcher**를 검색하여 선택합니다**. 토폴로지 **** 블레이드를 선택하여 가상 네트워크 인프라를 봅니다. 네트워크를 마우스로 가리키면 서브넷 및 IP 주소 지정 정보를 볼 수 있습니다. 

## 작업 2: Azure Load Balancer 구현

이 작업에서는 허브 가상 네트워크의 두 Azure 가상 머신 앞에 Azure Load Balancer를 구현합니다. Azure의 Load Balancer는 가상 머신과 같은 리소스 간에 계층 4 연결을 제공합니다. Load Balancer 구성에는 연결을 허용하는 프런트 엔드 IP 주소, 백 엔드 풀 및 연결이 부하 분산 장치를 트래버스하는 방법을 정의하는 규칙이 포함됩니다.


## 아키텍처 다이어그램 - Load Balancer

>**참고**: Load Balancer는 동일한 가상 네트워크의 두 가상 머신에 분산되어 있습니다. 


![랩 작업의 다이어그램.](../media/az104-lab06lb-architecture-diagram.png)


1. Azure Portal에서 검색하여 선택하고`Load balancers`, 부하 분산 장치** 블레이드에서 **+ 만들기**를 클릭합니다**.

1. 다음 설정을 사용하여 부하 분산 장치를 만든 다음(다른 설정은 기본값으로 유지), **다음: 프런트 엔드 IP 구성**을 클릭합니다.

    | 설정 | 값 |
    | --- | --- |
    | 구독 | Azure 구독의 이름 |
    | Resource group | **az104-rg6** |
    | 이름 | `az104-lb` |
    | 지역 | VM을 **배포한 동일한** 지역 |
    | SKU  | **표준** |
    | Type | **공용** |
    | 서비스 계층 | **Regional** |
    
     ![부하 분산 장치 만들기 페이지의 스크린샷](../media/az104-lab06-create-lb1.png)

1. **프런트 엔드 IP 구성** 탭에서 **프런트 엔드 IP 구성 추가**를 클릭하고 다음 설정을 사용합니다.  
     
    | 설정 | 값 |
    | --- | --- |
    | 속성 | `az104-fe` |
    | IP 유형 | IP 주소 |
    | 공용 IP 주소 | **새로 만들기**를 선택합니다.|
    | 게이트웨이 부하 분산 장치 | 없음 |
    
1. **공용 IP 주소 추가** 팝업에서 **확인**을 클릭한 다음 **추가**를 클릭하여 다음 설정을 사용합니다. 완료되면 **다음: 백 엔드 풀**을 클릭합니다. 
     
    | 설정 | 값 |
    | --- | --- |
    | 속성 | `az104-pip` |
    | SKU | 표준 |
    | 서비스 계층 | 지역 |
    | 할당 | 정적 |
    | 라우팅 기본 설정 | **Microsoft 네트워크** |

1. **백 엔드 풀** 탭에서 **백 엔드 풀 추가**를 클릭합니다(다른 설정은 기본값으로 유지). **+ 추가**(두 번)를 클릭한 다음 다음: 인바운드 규칙을** 클릭합니다**. 

    | 설정 | 값 |
    | --- | --- |
    | 속성 | `az104-be` |
    | 가상 네트워크 | **az104-06-vnet1** |
    | 백 엔드 풀 구성 | **NIC** | 
    | IP 버전 | **IPv4** |
    | **추가**를 클릭하여 가상 머신을 추가합니다. |  |
    | az104-vm0 | **확인란 선택** |
    | az104-vm1 | **확인란 선택** |

1. **인바운드 규칙** 탭에서 **부하 분산 규칙 추가**를 클릭합니다. 다음 설정을 사용하여 부하 분산 규칙을 추가합니다(다른 설정은 기본값으로 유지). 완료되면 **추가**를 클릭합니다.

    | 설정 | 값 |
    | --- | --- |
    | 속성 | `az104-lbrule` |
    | IP 버전 | **IPv4** |
    | 프런트 엔드 IP 주소 | **az104-fe** |
    | 백 엔드 풀 | **az104-be** |
    | 프로토콜 | **TCP** |
    | 포트 | `80` |
    | 백 엔드 포트 | `80` |
    | 상태 프로브 | **새로 만들기** |
    | 이름 | `az104-hp` |
    | 프로토콜 | **TCP** |
    | 포트 | `80` |
    | 간격 | `5` |
    | 상태 프로브 만들기 창 닫기 | **저장** | 
    | 세션 지속성 | **없음** |
    | 유휴 제한 시간(분) | `4` |
    | TCP 재설정 | **사용 안 함** |
    | 부동 IP | **사용 안 함** |
    | 아웃바운드 SNAT(Source Network Address Translation) | **권장** |

1. 시간이 있으므로 다른 탭을 검토한 다음 **검토 후 만들기**를 클릭합니다. 유효성 검사 오류가 없는지 확인하고 **만들기**를 클릭합니다. 

1. 부하 분산 장치가 배포되기를 기다린 다음 **리소스로 이동**을 클릭합니다.  

1. 부하 부산 장치 리소스 페이지에서 **프런트 엔드 IP 구성**을 선택합니다. 공용 IP 주소를 복사합니다.

1. 다른 브라우저 탭을 열고 IP 주소로 이동합니다. 브라우저 창에 **az104-06-vm0의 Hello World** 또는 **az104-06-vm1의 Hello World** 메시지가 표시되는지 확인합니다.

1. 창을 새로 고쳐 메시지가 다른 가상 머신으로 변경되었는지 확인합니다. 이는 가상 머신을 통해 회전하는 부하 분산 장치를 나타냅니다.

    > **참고**: InPrivate 모드에서 브라우저 창을 두 번 이상 새로 고치거나 새로 열어야 할 수 있습니다.

### vm0과 vm1 간의 연결 테스트 

1. Azure Portal에서 검색하여 선택합니다 `Network Watcher`.

1. Network Watcher의 네트워크 진단 도구 메뉴에서 커넥트ion 문제 해결**을 선택합니다**.

1. 다음 정보를 사용하여 커넥트ion 문제 해결** 페이지의 필드를 **완료합니다.

    | 필드 | 값 | 
    | --- | --- |
    | 소스 형식           | **가상 머신**   |
    | 가상 머신       | **vm0**    | 
    | 대상 형식      | **가상 머신**   |
    | 가상 머신       | **vm1**   | 
    | 기본 설정 IP 버전  | **모두**              | 
    | 프로토콜              | **TCP**               |
    | 대상 포트      | `3389`                |  
    | 원본 포트           | *Blank*         |
    | 진단 테스트      | *Defaults*      |

    ![커넥트ion 문제 해결 설정을 보여 주는 Azure Portal](../media/az104-lab05-connection-troubleshoot.png)

1. **진단 테스트 실행**을 선택합니다.

    >**참고**: 결과가 반환되는 데 몇 분 정도 걸릴 수 있습니다. 결과가 수집되는 동안 화면 선택이 회색으로 표시됩니다. **커넥트성 테스트**는 Reachable을 표시**합니다**. 가상 머신이 동일한 가상 네트워크에 있기 때문에 이는 의미가 있습니다. 

## 작업 3: Azure 애플리케이션 게이트웨이 구현

이 작업에서는 스포크 가상 네트워크의 두 Azure 가상 머신 앞에 Azure Application Gateway를 구현합니다. Application Gateway는 백 엔드 풀에 정의된 리소스에 계층 7 부하 분산, WAF(웹 애플리케이션 방화벽), SSL 종료 및 엔드투엔드 암호화를 제공합니다. 

## 아키텍처 다이어그램 - Application Gateway

>**참고**: Application Gateway는 서로 다른 두 가상 네트워크의 두 가상 머신에 분산됩니다. 


![랩 작업의 다이어그램.](../media/az104-lab06gw-architecture-diagram.png)

1. Azure Portal에서 검색하고 선택합니다 `Virtual networks`.

1. **가상 네트워크** 블레이드의 가상 네트워크 목록에서 az104-vnet1**을 클릭합니다**.

1. az104-vnet1** 가상 네트워크 블레이드의 **설정** 섹션에서 서브넷을 클릭한 **다음 + 서브넷**** 을 클릭합니다**.**

1. 다음 설정을 사용하여 서브넷을 추가합니다(다른 사용자는 기본값을 그대로 둡니다).

    | 설정 | 값 |
    | --- | --- |
    | 속성 | `subnet-appgw` |
    | 서브넷 주소 범위 | `10.60.3.224/27` |

1. 페이지 맨 아래에 있는 **저장**

    > **참고**: 이 서브넷은 Azure Application Gateway 인스턴스에서 사용되며 이 작업의 후반부에서 배포합니다. Application Gateway에는 27 또는 그 이상 크기의 전용 서브넷이 필요합니다. 이 단계는 Application Gateway를 만드는 동안 수행되었을 수 있습니다. 

1. Azure Portal에서 검색하고 선택하고 `Application Gateways` Application Gateway 블레이드**에서 **+ 만들기**를 클릭합니다**.

1. **기본 사항** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 유지).

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용 중인 Azure 구독의 이름 |
    | Resource group | `az104-rg6` |
    | Application Gateway 이름 | `az104-appgw` |
    | 지역 | **작업 1에서 사용한 것과 동일한** Azure 지역 |
    | 서비스 계층 | **표준 V2** |
    | 자동 크기 조정 사용 | **아니요** |
    | 인스턴트 수 | `2` |
    | 가용성 영역 | **없음** |
    | HTTP2 | **사용 안 함** |
    | 가상 네트워크 | **az104-06-vnet1** |
    | 서브넷 | **subnet-appgw (10.60.3.224/27)** |

    ![앱 게이트웨이 만들기 페이지의 스크린샷.](../media/az104-lab06-create-appgw.png)

1. **다음: 프런트 엔드 >** 를 클릭하고 다음 설정을 지정합니다(다른 설정은 기본값으로 유지). 완료한 경우 **확인**을 클릭합니다. 

    | 설정 | 값 |
    | --- | --- |
    | 프런트 엔드 IP 주소 유형 | **공용** |
    | 공용 IP 주소| **새로 추가** | 
    | 이름 | `az104-gwpip` |
    | 가용성 영역 | **없음** |

1. **다음: 백 엔드 >** 를 클릭한 다음 **백 엔드 풀 추가**를 클릭합니다. 다음 설정을 지정합니다(다른 설정은 기본값으로 유지). 완료되면 **추가**를 클릭합니다.

    | 설정 | 값 |
    | --- | --- |
    | 속성 | `az104-appgwbe` |
    | 대상 없이 백 엔드 풀 추가 | **아니요** |
    | IP 주소 또는 FQDN | **10.62.0.4** | 
    | IP 주소 또는 FQDN | **10.63.0.4** |

    > **참고**: 대상은 가상 머신 **az104-vm0** 및 **az104-vm1**의 개인 IP 주소를 나타냅니다.

1. **다음: 구성 >** 을 클릭한 다음 **+ 라우팅 규칙 추가**를 클릭합니다. 다음 설정을 지정합니다.

    | 설정 | 값 |
    | --- | --- |
    | 규칙 이름 | `az104-rule` |
    | 우선 순위 | `10` |
    | 수신기 이름 | `az104-listener` |
    | 프런트 엔드 IP | **공용** |
    | 프로토콜 | **HTTP** |
    | 포트 | `80` |
    | 수신기 유형 | **기본** |

    ![앱 게이트웨이 규칙 만들기 페이지의 스크린샷.](../media/az104-lab06-appgw-rule.png)

1. **백 엔드 대상** 탭으로 전환하고 다음 설정을 지정합니다(다른 설정은 기본값으로 유지). 완료되면 추가 **(두 번)를 클릭합니다**.  

    | 설정 | 값 |
    | --- | --- |
    | 대상 형식 | **백 엔드 풀** |
    | 백 엔드 대상 | **az104-appgwbe** |
    | 백 엔드 설정 | **새로 추가** |
    | 백 엔드 설정 이름 | `az104-http` |
    | 백 엔드 프로토콜 | **HTTP** |
    | 백 엔드 포트 | `80` |
    | 추가 설정 | **기본값 사용** |
    | 호스트 이름 | **기본값 사용** |

1. **다음: 태그 >** , **다음: 검토 + 만들기>** 를 차례로 클릭한 후에 **만들기**를 클릭합니다.

    > **참고**: Application Gateway 인스턴스가 만들어질 때까지 기다리세요. 약 5~10분이 소요됩니다.

1. Azure Portal에서 az104-appgw**를 검색하고 선택합니다**.

1. **az104-appgw** Application Gateway 블레이드에서 프런트 엔드 공용 IP 주소**의 **값을 복사합니다.

1. 다른 브라우저 창을 시작하고 이전 단계에서 식별한 IP 주소로 이동합니다.

1. 브라우저 창에 az104-vm0 또는 **az104-vm1**의 헬로 월드 헬로 월드** 메시지가 **표시되는지 확인합니다.

1. 창을 새로 고쳐 메시지가 다른 가상 머신으로 변경되었는지 확인합니다. 

    > **참고**: InPrivate 모드에서 브라우저 창을 두 번 이상 새로 고치거나 새로 열어야 할 수 있습니다.

## 작업 4: Network Watcher를 사용하여 네트워크 연결 테스트

이 작업에서는 Azure Portal에서 Network Watcher를 사용하여 vritual 컴퓨터 간의 연결을 테스트합니다. Network Watcher는 연결이 실패하는 이유에* 대한 *문제 해결 및 추가 정보를 제공합니다. Network Watcher에는 네트워크 문제 해결에 도움이 될 수 있는 몇 가지 도구가 포함되어 있습니다.

### vm0과 vm1 간의 연결 테스트 

1. Azure Portal에서 검색하여 선택합니다 `Network Watcher`.

1. Network Watcher의 네트워크 진단 도구 메뉴에서 커넥트ion 문제 해결**을 선택합니다**.

1. 다음 정보를 사용하여 커넥트ion 문제 해결** 페이지의 필드를 **완료합니다.

    | 필드 | 값 | 
    | --- | --- |
    | 소스 형식           | **가상 머신**   |
    | 가상 머신       | **vm0**    | 
    | 대상 형식      | **가상 머신**   |
    | 가상 머신       | **vm1**   | 
    | 기본 설정 IP 버전  | **모두**              | 
    | 프로토콜              | **TCP**               |
    | 대상 포트      | `3389`                |  
    | 원본 포트           | *Blank*         |
    | 진단 테스트      | *Defaults*      |

    ![커넥트ion 문제 해결 설정을 보여 주는 Azure Portal](../media/az104-lab05-connection-troubleshoot.png)

1. **진단 테스트 실행**을 선택합니다.

    >**참고**: 결과가 반환되는 데 몇 분 정도 걸릴 수 있습니다. 결과가 수집되는 동안 화면 선택이 회색으로 표시됩니다. **커넥트성 테스트**는 Reachable을 표시**합니다**. 가상 머신이 동일한 가상 네트워크에 있기 때문에 이는 의미가 있습니다. 

### vm2와 vm3 간의 연결 테스트 

1. Network Watcher**를 사용한 **FContinue.

1. 커넥트ion 문제 해결**을 선택합니다**.

1. 다음 정보를 사용하여 커넥트ion 문제 해결** 페이지의 필드를 **완료합니다.

    | 필드 | 값 | 
    | --- | --- |
    | 소스 형식           | **가상 머신**   |
    | 가상 머신       | **vm0**    | 
    | 대상 형식      | **가상 머신**   |
    | 가상 머신       | **vm3**   | 
    | 기본 설정 IP 버전  | **모두**              | 
    | 프로토콜              | **TCP**               |
    | 대상 포트      | `3389`                |  
    | 원본 포트           | *Blank*         |
    | 진단 테스트      | *Defaults*      |

    ![커넥트ion 문제 해결 설정을 보여 주는 Azure Portal](../media/az104-lab05-connection-troubleshoot.png)

1. **진단 테스트 실행**을 선택합니다.

    >**참고**: **커넥트성 테스트**에 연결할 수 없음**이 표시됩니다**. 이는 가상 머신이 서로 다른 가상 네트워크에 있기 때문에 의미가 있습니다. 

## 랩의 기본 지점 검토

랩을 완료한 것을 축하합니다. 다음은 이 랩에 대한 기본 설명입니다. 

+ Azure Load Balancer는 전송 계층(OSI 계층 4 - TCP 및 UDP)의 여러 가상 머신에 네트워크 트래픽을 분산하는 데 적합합니다.
+ 공용 Load Balancer는 인터넷 트래픽 부하를 VM에 분산하는 데 사용됩니다. 내부(또는 개인) 부하 분산 장치는 프라이빗 IP가 프런트 엔드에서만 필요한 경우에 사용됩니다.
+ 기본 부하 분산 장치는 고가용성 또는 중복성이 필요하지 않은 소규모 애플리케이션을 위한 것입니다. 표준 부하 분산 장치는 고성능 및 매우 낮은 대기 시간을 위한 것입니다.
+ Azure Application Gateway는 웹 애플리케이션 트래픽을 관리할 수 있는 웹 트래픽(OSI 계층 7) 부하 분산 장치입니다. 
+ Application Gateway는 HTTP 요청의 추가 특성(예: URI 경로 또는 호스트 헤더)에 따라 라우팅 결정을 내릴 수 있습니다. 

## 리소스 정리

고유한 구독으로 작업하는 경우 랩 리소스를 삭제하는 데 1분이 소요됩니다. 이렇게 하면 리소스가 해제되고 비용이 최소화됩니다. 랩 리소스를 삭제하는 가장 쉬운 방법은 랩 리소스 그룹을 삭제하는 것입니다. 

+ Azure Portal에서 리소스 그룹을 선택하고, 리소스 그룹 삭제를 선택하고 **, **리소스 그룹** 이름을** 입력한 다음, 삭제**를 클릭합니다**.

+ Azure PowerShell 사용. `Remove-AzResourceGroup -Name resourceGroupName` 

+ CLI `az group delete --name resourceGroupName`를 사용하여 .
