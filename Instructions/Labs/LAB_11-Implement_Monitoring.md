---
lab:
  title: '랩 11: 모니터링 구현'
  module: Administer Monitoring
---

# 랩 11 - 모니터링 구현

## 랩 소개

이 랩에서는 Azure Monitor에 대해 알아봅니다. 경고를 만들어 작업 그룹에 보내는 방법을 알아봅니다. 경고를 트리거 및 테스트하고 활동 로그를 확인합니다.  

이 랩을 수행하려면 Azure 구독이 필요합니다. 구독 유형은 이 랩의 기능 가용성에 영향을 미칠 수 있습니다. 지역을 변경할 수 있지만 단계는 **미국 동부**를 사용하여 작성됩니다.

## 예상 소요 시간: 40분

## 랩 시나리오

사용자의 조직은 인프라를 Azure로 마이그레이션했습니다. 중요한 인프라 변경 내용을 관리자에게 알리는 것이 중요합니다. Log Analytics를 포함하여 Azure Monitor의 기능을 검사할 계획입니다.

## 대화형 랩 시뮬레이션

이 항목에 유용할 수 있는 대화형 랩 시뮬레이션이 있습니다. 시뮬레이션을 통해 고유의 속도에 맞춰 유사한 시나리오를 클릭할 수 있습니다. 대화형 시뮬레이션과 이 랩에는 차이점이 있지만 핵심 개념은 대부분 동일합니다. Azure 구독은 필요하지 않습니다.

+ [모니터링을 구현합니다.](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2017) Log Analytics 작업 영역 및 Azure 자동화 솔루션을 만듭니다. 가상 머신에 대한 모니터링 및 진단 설정을 검토합니다. Azure Monitor 및 Log Analytics 기능을 검토합니다. 

## 아키텍처 다이어그램

![아키텍처 작업 다이어그램](../media/az104-lab11-architecture.png)

## 작업 기술

+ 작업 1: 템플릿을 사용하여 인프라를 프로비전합니다.
+ 작업 2: 경고를 만듭니다.
+ 작업 3: 작업 그룹 알림을 구성합니다.
+ 작업 4: 경고를 트리거하고 작동하는지 확인합니다.
+ 작업 5: 경고 처리 규칙을 구성합니다.
+ 작업 6: Azure Monitor 로그 쿼리를 사용합니다.

## 작업 1: 템플릿을 사용하여 인프라 프로비전

이 작업에서는 모니터링 시나리오를 테스트하는 데 사용할 가상 머신을 배포합니다.

1. **\\Allfiles\\Lab11\\az104-11-vm-template.json** 랩 파일을 컴퓨터에 다운로드합니다.

1. **Azure Portal** - `https://portal.azure.com`에 로그인합니다.

1. Azure Portal에서 `Deploy a custom template`을 검색하여 선택합니다.

1. 사용자 지정 배포 페이지에서 **편집기에서 나만의 템플릿 만들기**를 선택합니다.

1. 템플릿 편집 페이지에서 **파일 로드**를 선택합니다.

1. **\\Allfiles\\Labs11\\az104-11-vm-template.json** 파일을 찾아 선택하고 **열기**를 선택합니다.

1. **저장**을 선택합니다.

1. 다음 정보를 사용하여 사용자 지정 배포 필드를 완료하고 다른 모든 필드는 기본값으로 둡니다.

    | 설정       | 값         | 
    | ---           | ---           |
    | Subscription  | Azure 구독 |
    | Resource group| `az104-rg11`(필요한 경우 **새로 만들기** 선택)
    | 지역        | **미국 동부**   |
    | 사용자 이름      | `localadmin`   |
    | 암호      | 복잡한 암호 제공 |
    
1. **검토 + 만들기**, **만들기**를 차례로 선택합니다.

1. 배포가 완료될 때까지 기다린 후 **리소스 그룹으로 이동**을 클릭합니다.

1. 배포된 리소스를 검토합니다. 하나의 가상 머신이 있는 하나의 가상 네트워크가 있어야 합니다.

**가상 머신에 대한 Azure Monitor 구성(마지막 작업에서 사용됨)**

1. 포털에서 **모니터링**을 검색하여 선택합니다.

1. 사용 가능한 모든 인사이트, 검색, 심사 및 진단 도구를 검토해 보세요.

1. **VM 인사이트** 상자에서 **보기**를 선택한 다음 **인사이트 구성**을 선택합니다.

1. 가상 머신을 선택한 다음 **사용**합니다(2번).

1. 구독 및 데이터 수집 규칙에 대한 기본값을 선택한 다음 **구성**을 선택합니다. 

1. 가상 머신 에이전트를 설치하고 구성하는 데 몇 분 정도 소요됩니다. 다음 단계를 진행합니다. 
   
## 작업 2: 경고 만들기

이 작업에서는 가상 머신이 삭제되는 시기에 대한 경고를 만듭니다. 

1. 계속해서 **모니터** 페이지에서 **경고**을 선택합니다. 

1. **만들기 +** 를 선택하고 **경고 규칙**을 선택합니다. 

1. 리소스 그룹 상자를 선택한 다음 **적용**을 선택합니다. 이 경고는 리소스 그룹의 모든 가상 머신에 적용됩니다. 또는 특정 컴퓨터 하나만 지정할 수도 있습니다. 

1. **조건** 탭을 선택한 다음 **모든 신호 보기** 링크를 선택합니다.

1. **Virtual Machines 삭제(Virtual Machines)** 를 검색하여 선택합니다. 다른 기본 제공 신호를 확인합니다. **적용**을 선택합니다.

1. **경고 논리** 영역(아래로 스크롤)에서 **이벤트 수준** 선택 사항을 검토합니다. 기본값인 **모두 선택됨**을 그대로 둡니다.

1. **상태** 선택을 검토합니다. 기본값인 **모두 선택됨**을 그대로 둡니다.

1. 다음 작업을 위해 **경고 규칙 만들기** 창을 열어 둡니다.

## 작업 3: 작업 그룹 알림 구성

이 작업에서는 경고가 트리거되면 운영팀에 이메일 경고를 보냅니다. 

1. 경고에 대한 작업을 계속합니다. **다음: 작업**을 선택한 다음 **작업 그룹 만들기**를 선택합니다.

    >**유용한 정보** 경고 규칙에는 최대 5개의 작업 그룹을 추가할 수 있습니다. 작업 그룹은 특정 순서 없이 동시에 실행됩니다. 여러 경고 규칙에서 동일한 작업 그룹을 사용할 수 있습니다. 

1. **기본** 탭에서 각 설정에 다음 값을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | **프로젝트 세부 정보** |
    | Subscription | 구독 |
    | 리소스 그룹 | **az104-rg11** |
    | 지역 | **전역**(기본값) |
    | **인스턴스 세부 정보** |
    | 작업 그룹 이름 | `Alert the operations team`(리소스 그룹에서 고유해야 함) |
    | 표시 이름 | `AlertOpsTeam` |

1. **다음: 알림**을 선택하고 각 설정에 대해 다음 값을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | 알림 유형 | **메일/SMS 메시지/푸시/음성**을 선택합니다. |
    | 이름 | `VM was deleted` |

1. **이메일**을 선택하고 **이메일** 상자에 이메일 주소를 입력한 다음 **확인**을 선택합니다. 

    >**참고:** 작업 그룹에 추가되었다는 이메일 알림을 받아야 합니다. 몇 분 정도 지연될 수 있지만 이는 규칙이 배포되었다는 신호가 확실합니다.

1. 작업 그룹이 만들어지면 **다음: 세부 정보** 탭으로 이동하고 각 설정에 대해 다음 값을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | 경고 규칙 이름 | `VM was deleted` |
    | 경고 규칙 설명 | `A VM in your resource group was deleted` |

1. **검토 + 만들기**를 선택하여 입력의 유효성을 검사한 다음, **만들기**를 선택합니다.

## 작업 4: 경고를 트리거하고 작동하는지 확인합니다.

이 작업에서는 경고를 트리거하고 경고가 전송되었는지 확인합니다. 

>**참고:** 경고 규칙이 배포되기 전에 가상 머신을 삭제하면 경고 규칙이 트리거되지 않을 수 있습니다. 

1. 포털에서 **가상 머신**을 검색하여 선택합니다.

1. **az104-vm0** 가상 머신 확인란을 선택합니다.

1. 메뉴 모음에서 **삭제**를 선택합니다.

1. **강제 삭제 적용** 확인란을 선택합니다. 하단의 리소스 삭제 확인란을 선택하고 **삭제**를 선택합니다. 

1. 제목 표시줄에서 **알림** 아이콘을 선택하고 **vm0**이 성공적으로 삭제될 때까지 기다립니다.

1. 다음과 같은 알림 이메일을 받게 됩니다. **중요 공지: Azure Monitor 경고 VM이 삭제됨이 활성화되었습니다.** 이메일을 받지 못한 경우 이메일 프로그램을 열고 azure-noreply@microsoft.com에서 보낸 이메일을 찾습니다.

    ![경고 메일의 스크린샷.](../media/az104-lab11-alert-email.png)
   
1. Azure Portal 리소스 메뉴에서 **모니터**를 선택한 다음, 왼쪽 메뉴에서 **경고**를 선택합니다.

1. **vm0**을 삭제하여 생성된 세 가지 자세한 경고가 표시되어야 합니다.

   >**참고:** 경고 이메일이 전송되고 포털에서 경고가 업데이트되는 데 몇 분 정도 걸릴 수 있습니다. 기다리지 않으려면 다음 작업을 계속한 후 돌아옵니다. 

1. 경고 중 하나의 이름을 선택합니다(예: **VM이 삭제되었음**). 이벤트에 대한 자세한 정보를 보여주는 **경고 정보** 창이 표시됩니다.

## 작업 5: 경고 처리 규칙 구성

이 작업에서 유지 관리 기간 동안 경고를 표시하지 않는 경고 규칙을 만듭니다. 

1. 계속해서 **경고** 블레이드에서 **경고 처리 규칙**을 선택한 다음 **+ 만들기**를 선택합니다. 
   
1. **리소스 그룹**을 선택한 다음 **적용**을 선택합니다.
   
1. **다음: 규칙 설정**을 선택한 다음, **알림 표시 안 함**을 선택합니다.
   
1. **다음: 예약**을 선택합니다.
   
1. 기본적으로 규칙은 사용하지 않도록 설정하거나 일정을 구성하지 않는 한 항상 작동합니다. 야간 유지 관리 중에는 알림을 표시하지 않는 규칙을 정의하려고 합니다.
경고 처리 규칙의 일정에 대해 다음 설정을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | 규칙 적용 | 특정 시간에 |
    | 시작 | 오후 10시에 오늘 날짜를 입력합니다. |
    | 종료 | 오전 7시에 내일 날짜를 입력합니다. |
    | 표준 시간대 | 로컬 표준 시간대를 선택합니다. |

    ![경고 처리 규칙의 예약 섹션 스크린샷](../media/az104-lab11-alert-processing-rule-schedule.png)

1. **다음: 세부 정보**를 선택하고 다음 설정을 입력합니다.

    | 설정 | 값 |
    |---------|---------|
    | Resource group | **az104-rg11** |
    | 규칙 이름 | `Planned Maintenance` |
    | 설명 | `Suppress notifications during planned maintenance.` |

1. **검토 + 만들기**를 선택하여 입력의 유효성을 검사한 다음, **만들기**를 선택합니다.

## 작업 6: Azure Monitor 로그 쿼리 사용

이 작업에서는 Azure Monitor를 사용하여 가상 머신에서 캡처된 데이터를 쿼리합니다.

1. Azure Portal에서 `Monitor` 블레이드를 검색하여 선택하고 **로그**를 클릭합니다.

1. 필요한 경우 시작 화면을 닫습니다. 

1. 범위, 즉 **리소스 그룹**을 선택합니다. **적용**을 선택합니다. 

1. **쿼리** 탭에서 **가상 머신**(왼쪽 창)을 선택합니다. 

1. 사용 가능한 쿼리를 검토합니다. **하트비트 계산** 쿼리를 **실행**합니다(쿼리 위로 마우스를 가져갑니다).

1. 가상 머신이 실행 중일 때의 하트비트 수를 받아야 합니다.

1. 쿼리를 검토합니다. 이 쿼리는 *하트비트* 테이블을 사용합니다. 

1. 쿼리를 이 쿼리로 바꾼 다음 **실행**을 클릭합니다. 만들어진 차트를 검토합니다. 

   ```
    InsightsMetrics
    | where TimeGenerated > ago(1h)
    | where Name == "UtilizationPercentage"
    | summarize avg(Val) by bin(TimeGenerated, 5m), Computer //split up by computer
    | render timechart
   ```

1. 시간이 나면 다른 쿼리를 검토하고 실행해 보세요. 

    >**유용한 정보**: 다른 쿼리로 실습하려고 하려면 [Log Analytics 데모 환경](https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-tutorial#open-log-analytics)을 사용합니다.
    
    >**유용한 정보**: 원하는 쿼리를 찾으면 해당 쿼리에서 경고를 만들 수 있습니다. 

## 리소스 정리

**고유의 구독**으로 작업하는 경우 랩 리소스를 삭제해 보세요. 이렇게 하면 리소스가 확보되고 비용이 최소화됩니다. 랩 리소스를 삭제하려면 랩 리소스 그룹을 삭제하는 것이 가장 쉽습니다. 

+ Azure Portal에서 리소스 그룹을 선택하고 **리소스 그룹 삭제**, **리소스 그룹 이름 입력**을 선택한 다음 **삭제**를 클릭합니다.
+ Azure PowerShell 사용, `Remove-AzResourceGroup -Name resourceGroupName`.
+ CLI 사용, `az group delete --name resourceGroupName`.

## Copilot을 사용하여 학습 확장
Copilot은 Azure 스크립팅 도구를 사용하는 방법을 익히는 데 도움을 줍니다. 또한 Copilot은 랩에서 다루지 않는 영역이나 추가 정보가 필요한 영역을 지원할 수 있습니다. Edge 브라우저를 열고 Copilot(오른쪽 위)을 선택하거나 *copilot.microsoft.com*으로 이동하세요. 몇 분 정도 시간을 내어 이러한 프롬프트를 사용해 보세요.

+ 가상 머신이 다운될 때 Azure에서 경고해야 하는 기본 구성 단계는 무엇인가요?
+ Azure 경고가 트리거될 때 어떻게 알림을 받을 수 있나요?
+ 가상 머신 CPU 성능 정보를 제공하는 Azure Monitor 쿼리를 생성합니다.

## 자기 주도적 학습을 통해 자세히 알아보기

+ [Azure에서 경고를 사용하여 인시던트 대응 방식을 개선합니다](https://learn.microsoft.com/en-us/training/modules/incident-response-with-alerting-on-azure/). Azure Monitor의 경고 기능을 통해 인프라의 사고 및 작업에 응답합니다.
+ [Azure Monitor를 사용하여 Azure virtual machines를 모니터링합니다](https://learn.microsoft.com/en-us/training/modules/monitor-azure-vm-using-diagnostic-data/). Azure Monitor를 사용하여 VM 호스트 및 클라이언트 메트릭과 로그를 수집하고 분석함으로써 Azure VM을 모니터링합니다.

## 핵심 내용

축하합니다. 랩을 완료했습니다. 이 랩의 주요 내용은 다음과 같습니다. 

+ 경고를 통해 사용자가 인프라 또는 애플리케이션에 문제가 있을 수 있음을 알기 전에 문제를 검색하고 해결할 수 있습니다.
+ Azure Monitor 데이터 플랫폼의 모든 메트릭 또는 로그 데이터 원본에 대해 경고할 수 있습니다.
+ 경고 규칙은 데이터를 모니터링하고 지정된 리소스에서 문제가 발생하고 있음을 나타내는 신호를 캡처합니다.
+ 경고 규칙의 조건이 충족되면 경고이 트리거됩니다. 여러 작업(이메일, SMS, 푸시, 음성)이 트리거될 수 있습니다.
+ 작업 그룹에는 경고 알림을 받아야 하는 개인이 포함됩니다.
